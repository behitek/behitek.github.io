---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import ProjectCard from '@components/ProjectCard.astro';
import { getLangFromUrl, useTranslations } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all projects
const allProjects = await getCollection('projects');
const sortedProjects = allProjects.sort((a, b) => a.data.order - b.data.order);

// Group by category
const categories = ['Product', 'Research', 'Tutorial', 'Tool', 'Fun'] as const;
const projectsByCategory = categories.map((category) => ({
  category,
  projects: sortedProjects.filter((p) => p.data.category === category),
})).filter((group) => group.projects.length > 0);

// Category translations
const getCategoryName = (category: string) => {
  const key = category.toLowerCase() as keyof typeof t.projects.filter;
  return t.projects.filter[key] || category;
};
---

<BaseLayout
  title={t.projects.title}
  description={t.projects.subtitle}
>
  <div class="container py-12">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">ðŸš€ {t.projects.title}</h1>
      <p class="text-xl text-[var(--color-text-muted)] max-w-2xl mx-auto">
        {t.projects.subtitle}
      </p>
    </div>

    <!-- Category Filters -->
    <div class="flex flex-wrap items-center justify-center gap-4 mb-12">
      <button
        class="category-filter-btn active px-4 py-2 rounded-lg font-medium transition-all"
        data-category="all"
      >
        {t.projects.allProjects} ({sortedProjects.length})
      </button>
      {projectsByCategory.map((group) => (
        <button
          class="category-filter-btn px-4 py-2 rounded-lg font-medium transition-all"
          data-category={group.category.toLowerCase()}
        >
          {getCategoryName(group.category)} ({group.projects.length})
        </button>
      ))}
    </div>

    <!-- Projects Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
      {sortedProjects.map((project) => (
        <div
          class="project-item"
          data-category={project.data.category.toLowerCase()}
        >
          <ProjectCard {...project.data} />
        </div>
      ))}
    </div>

    <!-- View More Button -->
    <div class="text-center mb-12">
      <a
        href="https://github.com/behitek"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-primary-600 to-cyan-600 hover:from-primary-700 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1"
      >
        <span>{t.projects.viewMore}</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      </a>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-16">
      <p class="text-2xl text-[var(--color-text-muted)] mb-4">{t.projects.emptyState}</p>
      <button id="reset-category-filters" class="link text-lg">
        {t.projects.viewAll}
      </button>
    </div>
  </div>
</BaseLayout>

<style>
  .category-filter-btn {
    @apply bg-slate-100 dark:bg-slate-800 text-[var(--color-text-base)] hover:bg-primary-100 dark:hover:bg-primary-900 hover:text-primary-700 dark:hover:text-primary-300;
  }

  .category-filter-btn.active {
    @apply bg-primary-600 text-white hover:bg-primary-700;
  }
</style>

<script>
  // Client-side filtering
  const filterButtons = document.querySelectorAll('.category-filter-btn');
  const projectItems = document.querySelectorAll('.project-item');
  const emptyState = document.getElementById('empty-state');
  const resetButton = document.getElementById('reset-category-filters');

  filterButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');

      // Update active state
      filterButtons.forEach((btn) => btn.classList.remove('active'));
      button.classList.add('active');

      // Filter projects
      let visibleCount = 0;

      projectItems.forEach((item) => {
        const itemCategory = item.getAttribute('data-category');

        if (category === 'all' || itemCategory === category) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      // Show/hide empty state
      if (visibleCount === 0) {
        emptyState?.classList.remove('hidden');
      } else {
        emptyState?.classList.add('hidden');
      }
    });
  });

  // Reset filters
  resetButton?.addEventListener('click', () => {
    const allButton = document.querySelector('[data-category="all"]');
    (allButton as HTMLButtonElement)?.click();
  });
</script>
